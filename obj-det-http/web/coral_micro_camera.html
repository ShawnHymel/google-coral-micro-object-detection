<!--
 Copyright 2022 Google LLC
 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Coral Micro Cam HTTP</title>
    <script type="text/javascript">

        // TEST
        const imgUrl = "http://10.10.10.1/camera_stream";
        const bboxUrl = "http://10.10.10.1/bboxes";

        // // Coral Micro's image url.
        // const imgUrl = "/camera_stream";
        // const bboxUrl = "/bboxes";

        function isASCII(str) {
            return /^[\x00-\x7F]*$/.test(str);
}

        // Sleeps for micro seconds.
        function sleep (micro) {
            return new Promise((resolve) => setTimeout(resolve, micro));
        }

        // Draws bounding boxes on the canvas
        function drawBoundingBoxes(ctx, bboxes, imgElt) {
            bboxes.forEach(bbox => {
                let xmin = Math.max(bbox['xmin'] * imgElt.width, 0);
                let ymin = Math.max(bbox['ymin'] * imgElt.height, 0);
                let xmax = Math.min(bbox['xmax'] * imgElt.width, imgElt.width);
                let ymax = Math.min(bbox['ymax'] * imgElt.height, imgElt.height);

                // Draw box on the canvas
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#ff0000';
                ctx.font = '20px Arial';
                ctx.fillStyle = '#ff0000';
                ctx.beginPath();
                ctx.rect(xmin, ymin, xmax - xmin, ymax - ymin);
                ctx.stroke();
                ctx.fillText(bbox['id'], xmin, ymin - 5);
            });
        }
        
        // Main loop to fetch image and bounding boxes and draw them on the canvas
        async function updateImage () {
            const imgReader = new FileReader();
            const imgElt = document.getElementById("cam_canvas");
            const ctx = imgElt.getContext('2d');
            let img = new Image();

            let startTime = Date.now();

            // Do this forever
            while (1) {

                startTime = Date.now();
                console.log("--------------------");

                // Fetch image and bbox info
                let bboxInfo = null;
                let imageBlob = null;
                try {

                    console.log("0 Timestamp: ", Date.now() - startTime);

                    // Fetch bbox info and wait for it to complete
                    const bboxResponse = await fetch(bboxUrl);
                    const bboxStr = await bboxResponse.text();

                    console.log("1 Timestamp: ", Date.now() - startTime);

                    console.log("bboxStr: ", bboxStr);
                    bboxInfo = JSON.parse(bboxStr);
                    console.log("bboxInfo: ", bboxInfo);
                    console.log("2 Timestamp: ", Date.now() - startTime);

                    // Fetch image data and wait for it to complete
                    const imageResponse = await fetch(imgUrl);
                    imageBlob = await imageResponse.blob();

                    console.log("3 Timestamp: ", Date.now() - startTime);

                } catch (error) {
                    console.error("Error in fetching bbox or image: ", error);
                    continue;
                }

                // Handle errors
                if (!imageBlob || !bboxInfo) {
                    console.error("Error fetching data");
                    continue;
                }

                console.log("4 Timestamp: ", Date.now() - startTime);

                // Log bounding boxes
                console.log(bboxInfo);

                // Draw image and bounding boxes
                imgReader.readAsDataURL(imageBlob);
                imgReader.onloadend = () => {
                    img.onload = () => {
                        ctx.clearRect(0, 0, imgElt.width, imgElt.height);
                        ctx.drawImage(img, 0, 0, imgElt.width, imgElt.height);
                        if (bboxInfo.bboxes) {
                            drawBoundingBoxes(ctx, bboxInfo.bboxes, imgElt);
                        }
                    }
                    img.src = imgReader.result;
                }

                console.log("5 Timestamp: ", Date.now() - startTime);

                // Wait before fetching new image
                await sleep(10);
            }
        }

    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            color: #fd5e4d;
        }
        #main-container {
            border: 1px solid #53bfc1;
        }
        #coral-cam-title-container {
            white-space: nowrap;
            height: 45px;
            background: #fd5e4d;
            border-bottom: 1px solid #53bfc1;
        }
        .coral-cam-title {
            line-height: 45px;
            font-size: 30px;
            display: inline-block;
            color: #f5d0cb;
            padding-left: 10px;
        }
        #setting-menu {
            height: 50px;
            background: #f5d0cb;
            border-top: 1px solid #53bfc1;
        }
        .input-label {
            padding-left: 10px;
        }
    </style>
</head>
<body id="body" onload="updateImage()">
<div id="main-container">
    <div id="coral-cam-title-container">
        <label class="coral-cam-title">Coral Micro Cam</label>
    </div>
    <div id="setting-menu">
        <div style="margin-top: 10px"></div>
        <label for="image-width" class="input-label">Image Width:</label>
        <input id="image-width" type="number" required value=500>
        <label for="image-height" class="input-label">Image Height:</label>
        <input id="image-height" type="number" required value=500>
        <label for="image-rotation" class="input-label">Rotation:</label>
        <select name="image-rotation" id="image-rotation">
            <option value=0 selected>0</option>
            <option value=90>90</option>
            <option value=180>180</option>
            <option value=270>270</option>
        </select>
    </div>
    <canvas id="cam_canvas" width="500" height="500"></canvas>
</div>
</body>
</html>
